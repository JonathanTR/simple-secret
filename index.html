<!-- Uncomment for live reload -->
<!-- <script type="text/javascript" src="http://livejs.com/live.js"></script> -->

<!-- Constants -->
<script>
  const EMAIL_REGEX = /(.+)\s+<(.*?)>/;
  const VALID_EMAIL = /[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*/;
</script>

<!-- Formatters -->
<script>
  function formatGmail ({ to, subject, body }) {
    return `https://mail.google.com/mail/?view=cm&fs=1&to=${to}&su=${subject}&body=${body}`;
  }

  function formatMailTo ({ to, subject, body }) {
    return `mailto:${to}?subject=${subject}&body=${body}`;
  }

  function formatYahoo ({ to, subject, body }) {
    return `http://compose.mail.yahoo.com/?to=${to}&subj=${subject}&body=${body}`;
  }

  function formatOutlook ({ to, subject, body }) {
    return `https://outlook.live.com/owa/#subject=${subject}&body=${body}&to=${to}&path=%2fmail%2faction%2fcompose`;
  }

  function formatAOL ({ to, subject, body }) {
    return `http://mail.aol.com/mail/compose-message.aspx?to=${to}&subject=${subject}&body=${body}`;
  }

  const formatters = {
    gmail: formatGmail,
    desktop: formatMailTo,
    yahoo: formatYahoo,
    outlook: formatOutlook,
    aol: formatAOL,
  }
</script>

<!-- Helpers -->
<script>
  function createContactNode ({ name, to, subject, body, valid, formatter }) {
    var template = document.getElementById("contact-template");
    var contactNode = template.content.cloneNode(true);
    contactNode.querySelector(".name").textContent = name + ": ";
    contactNode.querySelector(".email").textContent = to;
    contactNode.querySelector(".send").href = formatter({ to, subject, body });
    if (valid) {
      contactNode.querySelector(".error").remove();
    } else {
      contactNode.querySelector(".send").remove();
      contactNode.querySelector(".error").textContent = "[invalid format]";
    }
    return contactNode;
  }
</script>

<!-- Application -->
<script>
  let STATE = {
    format: formatters.gmail,
    contacts: []
  }

  function updateFormatter (type = "gmail") {
    STATE.format = formatters[type] || formatters.gmail;
  }

  function updateContacts (list = "") {
    var contacts = list.split(",").map((input = "") => {
      var valid = VALID_EMAIL.test(input);
      var email = valid ? input.match(VALID_EMAIL)[0] : null;
      var name = input.replace(VALID_EMAIL, "").replace(/<.*>/g, "").trim();
      return { valid, name: name || email, email, input };
    });

    STATE.contacts = contacts;
  };


  function renderContactList () {
    var list = document.getElementById("list");
    list.innerHTML = "";

    STATE.contacts.forEach((contact) => {
      var { name, email, valid } = contact;
      var contactNode = createContactNode({
        name,
        to: email,
        subject: "Secret Santa Assignment",
        body: "You've been assigned: %0A" +
          Array(100).fill().map(() => ".").join("%0A") +
          `%0A %0A ${name} <${email}> %0A %0A `+
          "Merry Christmas, ya filthy animal ðŸŒ² ",
        valid,
        formatter: STATE.format
      });
      list.appendChild(contactNode);
    });
  }

  function handleSendByChange ({ target }) {
    console.log(target)
    updateFormatter(target.value);
    renderContactList();
  }

  function handleListChange () {
    var emailInput = document.getElementById("emails");
    updateContacts(emailInput.value);
    renderContactList();
  }


  document.addEventListener("DOMContentLoaded", function() {
    var sendByForm = document.getElementById("sendBy");
    sendByForm.addEventListener("change", handleSendByChange);
  });
</script>

<style>
  body {
    display: flex;
    align-items: center;
    flex-direction: column;
    text-align: center;
  }

  button, label { cursor: pointer }

  textarea {
    border-radius: 4px;
    height: 10em;
    padding: 1em;
    width: 30rem;
  }

  textarea:focus {
    border: 1px dashed forestgreen;
    outline: none;
  }

  ul:not(:empty) {
    border: 1px dashed salmon;
    padding: 1em 2em;
    border-radius: 4px;
    box-sizing: border-box;
    text-align: left;
    margin: 0 auto;
    width: 30rem;
  }

  address { display: flex; justify-content: space-between; }

  .name { font-weight: bold; font-style: normal; }
  li span:last-child { align-self: flex-end;}

  .error { color: firebrick }
</style>

<h1>Simple Secret Santa</h1>
<br>
<br>

<label for="sendBy">
  How do you send email?
</label>
<br>
<form id="sendBy">
  <label for="gmail">
    <input type="radio" name="sendBy" id="gmail" value="gmail" checked>
    Gmail
  </label>

  <label for="desktop">
    <input type="radio" name="sendBy" id="desktop" value="desktop">
    Desktop Mail
  </label>

  <label for="yahoo">
    <input type="radio" name="sendBy" id="yahoo" value="yahoo">
    Yahoo
  </label>

  <label for="outlook">
    <input type="radio" name="sendBy" id="outlook" value="outlook">
    Outlook
  </label>

  <label for="aol">
    <input type="radio" name="sendBy" id="aol" value="aol">
    Aol
  </label>
</form>
<br>
<br>
<br>


<label for="emails">
  Who would you like to include?
  <br>
</label>
<br>
<textarea
  id="emails"
  placeholder="Please enter a comma-separated list, with each item formatted as: Name &lt;name@email.com&gt;"
></textarea>
<br>
<button onclick="handleListChange()">Generate Assignments</button>
<br>
<br>
<br>

<ul id="list"></ul>

<!-- Contact List Template -->
<template id="contact-template">
  <li>
    <address>
      <span>
        <span class="name"></span>
        <span class="email"></span>
      </span>
      <a class="send" target="_blank">Send</a>
      <span class="error"></span>
    </address>
  </li>
</template>